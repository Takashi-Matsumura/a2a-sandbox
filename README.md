# A2A Protocol Sandbox

Google A2A (Agent-to-Agent) Protocol を学ぶためのインタラクティブなデモアプリケーションです。

## A2A Protocolとは？

A2A Protocol は、Google が提唱する **AI エージェント間の通信仕様** です。異なるエージェント同士がセキュリティとプライバシーを維持しながら、相互に通信・連携できるようにします。

### A2A Protocol の核心要素

| 要素 | 説明 |
|------|------|
| **Agent Cards** | エージェントの機能を公開するメタデータ（`/.well-known/agent.json`） |
| **Tasks** | 状態を持つやり取りの単位（JSON-RPC 2.0 ベース） |
| **Skills** | エージェントが提供する機能（例: `check-availability`, `schedule-meeting`） |
| **プライバシー制御** | 各エージェントが公開範囲を自律的に決定 |

### A2A Agent と一般的なAIチャットの違い

A2A Agent は ChatGPT のような汎用AIチャットとは異なり、**特定のタスクに特化**しています。

| 特徴 | 一般的なAIチャット（ChatGPT等） | A2A Agent |
|------|-------------------------------|-----------|
| **対応範囲** | 何でも答えようとする | 定義されたSkillsのみ |
| **予測可能性** | 応答が予測しにくい | 機能が明確に定義されている |
| **連携性** | 他システムとの連携が難しい | Agent Card で機能を公開、連携しやすい |
| **目的** | 汎用的な対話 | 特定のタスクを確実に実行 |

**なぜ範囲を限定するのか？**

1. **信頼性** - 決まった機能を確実に実行
2. **セキュリティ** - 意図しない情報漏洩を防ぐ
3. **相互運用性** - 他のシステム/エージェントが何を期待できるか明確
4. **責任の明確化** - このエージェントは何をするか/しないかが明白

**実装パターン**

```
ユーザーの入力
     ↓
┌─────────────────┐
│ 意図の解析      │ ← LLMまたはルールベース
│ (どのSkillか?)  │
└────────┬────────┘
         ↓
┌─────────────────┐
│ Skill実行       │ ← 実際のデータ処理
│ (スケジュール取得等)│
└────────┬────────┘
         ↓
    構造化された応答
```

このデモでは、エージェントは以下のSkillを提供します：

**スケジューリングエージェント（Alice, Bob, Carol）**
- `check-availability` - 空き状況の確認
- `get-busy-slots` - 予定の取得
- `schedule-meeting` - 会議の予約

**ディベートエージェント（賛成くん, 反対くん）**
- `debate-argue` - テーマに対する主張の展開
- `debate-rebut` - 相手の主張への反論

### エージェント間の通信パターン

A2A Protocol は柔軟な通信パターンをサポートしています：

#### 1. Orchestrator パターン（本デモで採用）

```
        ┌─────────────┐
        │ Orchestrator│
        └──────┬──────┘
               │
    ┌──────────┼──────────┐
    ▼          ▼          ▼
┌───────┐  ┌───────┐  ┌───────┐
│ Alice │  │  Bob  │  │ Carol │
└───────┘  └───────┘  └───────┘
```

中央の Orchestrator がエージェントを調整し、情報を集約します。複数エージェントの結果を統合する必要があるユースケース（会議調整など）に適しています。

#### 2. 直接通信パターン

```
┌───────┐         ┌───────┐
│Agent A│ ◄─────► │Agent B│
└───────┘         └───────┘
```

エージェント同士が直接タスクを送受信します。

#### 3. 連鎖パターン

```
┌───────┐     ┌───────┐     ┌───────┐
│Agent A│ ──► │Agent B│ ──► │Agent C│
└───────┘     └───────┘     └───────┘
```

処理を順番に委譲していきます。

**重要**: A2A Protocol は通信仕様であり、Orchestrator は必須ではありません。ユースケースに応じて適切なパターンを選択できます。

## このアプリでできること

### 1. 会議スケジューリングデモ

3つのAIエージェント（Alice, Bob, Carol）が協力して会議を調整する様子を観察できます。

- **エージェント探索**: Agent Cards による機能の発見
- **プライバシー保護**: 予定の詳細を隠しながら空き状況のみを共有
- **協調動作**: 共通の空き時間を見つけて会議を予約

### 2. ディベートショー（エンタメ版）

賛成くん vs 反対くんのエンターテイメント版ディベート! 6つのテーマから選んで、ステージ上での対決を楽しめます。

- **テーマ選択**: 6つのプリセットテーマをカードUIで選択
- **ステージ演出**: 左右にエージェントが対峙し、吹き出しアニメーションで掛け合い
- **3ラウンド制**: Round 1（主張）→ Round 2（反論）→ Final（まとめ）
- **ビジュアル演出**: アクティブスピーカーのグロー、考え中アニメーション、VS演出
- **プロトコルログ**: アコーディオンで折りたたみ表示（技術的な詳細を見たい人向け）

### 3. エージェントディベート（技術版）

賛成くんと反対くんの2エージェントが、A2A Protocol を通じてディベートを行います。

- **LLM連携**: llama.cpp (Qwen2.5) を使った動的な主張・反論生成
- **異なる立場**: 同じLLMでもシステムプロンプトにより賛成/反対の立場が分かれる
- **7ステップのフロー**: エージェント探索 → テーマ設定 → 主張 → 反論 → まとめ
- **テンプレートフォールバック**: LLMサーバーが起動していない場合はテンプレートベースで動作

```
┌──────────────┐
│  Orchestrator │  ブラウザ（デモページ）
└──────┬───────┘
       │ JSON-RPC tasks/send
       ▼
┌────────────┐    ┌────────────┐
│ 賛成くん    │    │ 反対くん    │
│ system:    │    │ system:    │
│「常に賛成」  │    │「常に反対」  │
└─────┬──────┘    └─────┬──────┘
      └────────┬────────┘
               ▼
      ┌──────────────┐
      │  llama.cpp   │
      │  (Qwen2.5)   │
      └──────────────┘
```

### 4. エージェントとのチャット

個別のエージェントと対話して、その機能を試すことができます。

#### チャットの使用例

日本語・英語の両方に対応しています。

**予定を確認する（get-busy-slots）**
```
今日の予定を教えて
今日のスケジュールは？
What times are you busy today?
```

**空き状況を確認する（check-availability）**
```
今日の14:00から15:00は空いていますか？
Are you available from 14:00 to 15:00 today?
```

**会議を予約する（schedule-meeting）**
```
「チームミーティング」を14:00から15:00に予約
Schedule meeting "Team Sync" today from 14:00 to 15:00
```

#### 認識されるキーワード

| 機能 | 日本語キーワード | 英語キーワード |
|------|----------------|---------------|
| 予定確認 | 予定、スケジュール | busy, schedule |
| 空き確認 | 空いて、空き | available, free |
| 会議予約 | 予約、登録 | schedule, book |

### 5. Agent Card の確認

A2A Protocol 仕様に基づくエージェントのメタデータを確認できます。

## 学習の進め方

1. **デモ一覧ページ** (`/demo`) から始めて、3つのデモを体験
2. **会議スケジューリングデモ** でプライバシー保護付きの協調動作を観察
3. **ディベートショー** でエンタメ版のエージェント対決を体験
4. **ディベート（技術版）** でLLM連携によるエージェント間の対話フローを確認
5. **A2A Protocol メッセージ** パネルで JSON-RPC のリクエスト/レスポンスを確認
6. **エージェントページ** で個別のエージェントとチャット
7. **Agent Card タブ** でメタデータ仕様を理解

## 技術スタック

- **フレームワーク**: Next.js 16 (App Router)
- **LLM**: llama.cpp (Qwen2.5) — OpenAI互換API
- **データベース**: SQLite (better-sqlite3)
- **スタイリング**: Tailwind CSS
- **プロトコル**: JSON-RPC 2.0

## セットアップ

### 必要条件

- Node.js 18 以上
- npm または yarn

### インストール

```bash
# 依存関係のインストール
npm install

# 開発サーバーの起動
npm run dev
```

ブラウザで [http://localhost:3000](http://localhost:3000) を開いてください。

### LLM サーバー（ディベートデモ用・任意）

ディベートデモでLLMによる動的な主張生成を行うには、llama.cpp サーバーを起動してください。

```bash
# llama.cpp サーバーの起動例（Qwen2.5）
llama-server -m qwen2.5-7b.gguf --port 8080
```

LLM サーバーが起動していない場合は、テンプレートベースのフォールバックが自動的に使用されます。環境変数 `LLM_BASE_URL` でエンドポイントを変更できます（デフォルト: `http://localhost:8080`）。

## プロジェクト構造

```
a2a-sandbox/
├── app/                    # Next.js App Router
│   ├── api/               # API エンドポイント
│   │   ├── agents/        # エージェント関連 API
│   │   ├── tasks/         # タスク管理 API
│   │   ├── llm/           # LLM プロキシ API
│   │   └── db/            # データベース初期化
│   ├── agents/            # エージェントページ
│   ├── demo/
│   │   ├── schedule/      # 会議スケジューリングデモ
│   │   ├── debate-show/   # ディベートショー（エンタメ版）
│   │   └── debate/        # ディベートデモ（技術版）
│   └── .well-known/       # Agent Cards エンドポイント
├── components/            # React コンポーネント
│   ├── agents/            # エージェント関連
│   ├── chat/              # チャット UI
│   ├── demo/              # デモ用コンポーネント
│   └── schedule/          # スケジュール表示
├── lib/                   # ライブラリ・ユーティリティ
│   ├── a2a/               # A2A Protocol 実装
│   ├── agents/            # エージェント定義
│   │   └── debate/        # ディベートエージェント
│   ├── db/                # データベース操作
│   ├── llm/               # LLM クライアント
│   └── privacy/           # プライバシーフィルター
└── data/                  # SQLite データベースファイル
```

## A2A Protocol 仕様

### Agent Card の例

```json
{
  "name": "Alice's Assistant",
  "url": "/api/agents/alice",
  "capabilities": {
    "streaming": false,
    "pushNotifications": false
  },
  "skills": [
    {
      "id": "check-availability",
      "name": "Check Availability",
      "description": "Check if the user is available at a specific time"
    }
  ],
  "protocolVersions": ["1.0"]
}
```

### タスク送信リクエストの例

```json
{
  "jsonrpc": "2.0",
  "id": "req_123",
  "method": "tasks/send",
  "params": {
    "message": {
      "role": "user",
      "parts": [
        { "type": "text", "text": "What times are you busy today?" }
      ]
    }
  }
}
```

## 参考リンク

- [Google A2A Protocol 公式ドキュメント](https://github.com/google/A2A)
- [JSON-RPC 2.0 仕様](https://www.jsonrpc.org/specification)

## ライセンス

MIT
